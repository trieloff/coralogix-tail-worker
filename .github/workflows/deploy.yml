name: Deploy Coralogix Tail Worker

on:
  push:
    branches:
      - '**'  # Deploy on all branch pushes
      - '!develop'  # Exclude develop branch (reserved for local development)
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Parse Cloudflare tokens and create matrix
        id: set-matrix
        run: |
          # Write tokens to temporary file to handle multiline properly
          echo '${{ secrets.CLOUDFLARE_TOKENS }}' > /tmp/tokens.txt

          # Create JSON array for matrix
          matrix_json="["
          account_index=1
          first_token=true

          while IFS= read -r token || [[ -n "$token" ]]; do
            # Skip empty lines and trim whitespace
            token=$(echo "$token" | xargs)
            if [[ -n "$token" ]]; then
              if [[ "$first_token" == "false" ]]; then
                matrix_json+=","
              fi
              matrix_json+="{\"account_index\":$account_index,\"token\":\"$token\"}"
              account_index=$((account_index + 1))
              first_token=false
            fi
          done < /tmp/tokens.txt

          matrix_json+="]"

          # Clean up
          rm -f /tmp/tokens.txt

          # Validate matrix has at least one entry
          if [[ "$matrix_json" == "[]" ]]; then
            echo "ERROR: No valid Cloudflare tokens found in CLOUDFLARE_TOKENS secret"
            echo "Please check that CLOUDFLARE_TOKENS is set with line-separated tokens"
            exit 1
          fi

          echo "matrix={\"include\":$matrix_json}" >> $GITHUB_OUTPUT
          echo "Generated matrix: {\"include\":$matrix_json}"
          echo "Number of accounts: $((account_index - 1))"

  deploy:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    if: needs.prepare-matrix.outputs.matrix != '{"include":[]}'
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
      fail-fast: false  # Continue deploying to other accounts even if one fails

    environment: ${{ needs.prepare-matrix.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Setup Wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ matrix.token }}
          wranglerVersion: '3.114.15'

      - name: Set Coralogix API Key
        run: |
          echo "Setting shared Coralogix API key..."
          if [[ "${{ needs.prepare-matrix.outputs.environment }}" == "production" ]]; then
            wrangler secret put CORALOGIX_API_KEY --env production <<< "${{ secrets.CORALOGIX_API_KEY }}"
          else
            wrangler secret put CORALOGIX_API_KEY --env staging <<< "${{ secrets.CORALOGIX_API_KEY }}"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ matrix.token }}

      - name: Deploy to Production
        if: needs.prepare-matrix.outputs.environment == 'production'
        run: |
          echo "ðŸš€ Deploying to PRODUCTION (Account ${{ matrix.account_index }})"
          wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ matrix.token }}

      - name: Deploy to Staging
        if: needs.prepare-matrix.outputs.environment == 'staging'
        run: |
          echo "ðŸ§ª Deploying to STAGING (Account ${{ matrix.account_index }})"
          wrangler deploy --env staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ matrix.token }}

      - name: Deployment Summary
        run: |
          echo "## ðŸŽ¯ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.prepare-matrix.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Account**: ${{ matrix.account_index }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.prepare-matrix.outputs.environment }}" == "production" ]]; then
            echo "- **Worker Name**: coralogix-tail-worker-production" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Worker Name**: coralogix-tail-worker-staging" >> $GITHUB_STEP_SUMMARY
          fi

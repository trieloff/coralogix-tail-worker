name: Deploy Coralogix Tail Worker

on:
  push:
    branches:
      - '**'  # Deploy on all branch pushes
      - '!develop'  # Exclude develop branch (reserved for local development)
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Parse Cloudflare tokens and create matrix
        id: set-matrix
        env:
          TOKENS: ${{ secrets.CLOUDFLARE_TOKENS }}
        run: |
          echo "Debug: Raw CLOUDFLARE_TOKENS content:"
          echo "[$TOKENS]"
          echo "---"

          # Use Python for more reliable JSON generation
          python3 << 'EOF'
          import os
          import json

          tokens_raw = os.environ.get('TOKENS', '').strip()
          print(f"Python received tokens: [{tokens_raw}]")

          if not tokens_raw:
              print("ERROR: CLOUDFLARE_TOKENS secret is empty")
              exit(1)

          # Split by newlines and filter out empty lines
          tokens = [token.strip() for token in tokens_raw.split('\n') if token.strip()]

          print(f"Found {len(tokens)} token(s)")

          if not tokens:
              print("ERROR: No valid tokens found after parsing")
              exit(1)

          # Create matrix entries
          matrix_entries = []
          for i, token in enumerate(tokens, 1):
              matrix_entries.append({
                  "account_index": i,
                  "token": token
              })

          matrix = {"include": matrix_entries}
          matrix_json = json.dumps(matrix)

          print(f"Generated matrix: {matrix_json}")

          # Write to GitHub output
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"matrix={matrix_json}\n")
          EOF

  deploy:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    if: needs.prepare-matrix.outputs.matrix != '{"include":[]}'
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
      fail-fast: false  # Continue deploying to other accounts even if one fails

    environment: ${{ needs.prepare-matrix.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Setup Wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ matrix.token }}
          wranglerVersion: '3.114.15'

      - name: Set Coralogix API Key
        run: |
          echo "Setting shared Coralogix API key..."
          if [[ "${{ needs.prepare-matrix.outputs.environment }}" == "production" ]]; then
            wrangler secret put CORALOGIX_API_KEY --env production <<< "${{ secrets.CORALOGIX_API_KEY }}"
          else
            wrangler secret put CORALOGIX_API_KEY --env staging <<< "${{ secrets.CORALOGIX_API_KEY }}"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ matrix.token }}

      - name: Deploy to Production
        if: needs.prepare-matrix.outputs.environment == 'production'
        run: |
          echo "ðŸš€ Deploying to PRODUCTION (Account ${{ matrix.account_index }})"
          wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ matrix.token }}

      - name: Deploy to Staging
        if: needs.prepare-matrix.outputs.environment == 'staging'
        run: |
          echo "ðŸ§ª Deploying to STAGING (Account ${{ matrix.account_index }})"
          wrangler deploy --env staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ matrix.token }}

      - name: Deployment Summary
        run: |
          echo "## ðŸŽ¯ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.prepare-matrix.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Account**: ${{ matrix.account_index }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.prepare-matrix.outputs.environment }}" == "production" ]]; then
            echo "- **Worker Name**: coralogix-tail-worker-production" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Worker Name**: coralogix-tail-worker-staging" >> $GITHUB_STEP_SUMMARY
          fi
